<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title> Air Quality Monitoring </title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="css/style.css">   
    
</head>
    
<body>
<div id='map'></div>
    <div id='console'>
      <h1>Hourly Air Pollution Levels</h1>
      <p>Data: <a href='https://www.luchtmeetnet.nl/download'>Pollution Concentrations</a> in Amsterdam, The Netherlands</p>

      <div class='session'>
          <h2>NO2 Concentration (Î¼g/m3)</h2>
          <div class='row colors'></div>
          <div class='row labels'>
            <div class='label'>0</div>
            <div class='label'>25</div>
            <div class='label'>75</div>
            <div class='label'>100</div>
            <div class='label'>125</div>
            <div class='label'>150+</div>
          </div>
      </div>  

      <div class='session' id='sliderbar'>
          <h2>Hour: <label id='active-hour'>12PM</label></h2>
          <input id='slider' class='row' type='range' min='0' max='23' step='1' value='12' />
      </div>

      <div class='session'>
          <h2>Day of the week</h2>
          <div class='row' id='filters'>
            <input id='all' type='radio' name='toggle' value='all' checked='checked'>
            <label for='all'>All</label>
            <input id='weekday' type='radio' name='toggle' value='weekday'>
            <label for='weekday'>Weekday</label>
            <input id='weekend' type='radio' name='toggle' value='weekend'>
            <label for='weekend'>Weekend</label>
          </div>
      </div>

    </div>

    
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZGhlY2h0IiwiYSI6ImNqNHRueTVyeDA3ZmYyd3FuY2NmYW9tNmoifQ.FetU2-IBDcrhTmSKBpFIfA';

    var map = new mapboxgl.Map({
          container: 'map', // container id
          style:  'mapbox://styles/dhecht/cj53sifm400tw2smg5jlerack', // stylesheet location
          center: [4.899431, 52.379189], // long lat
          zoom: 11.8 // starting zoom
    });
        
    // Add geolocate control to the map.
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        trackUserLocation: true
    }));
       
    map.on('load', function() {
              var filterHour = ['in', 'DateTime', '12:00:00+02:00'];
              var filterDay = ['!=', 'Day', 'Bob'];

              map.addLayer({
                id: 'pollutants',
                type: 'circle',
                filter: ['all', filterHour, filterDay],
                source: {
                  type: 'geojson',
                  data: 'data/ams_stadhouderskade_5-01-2017.geojson'
                },
                paint: {
                  'circle-radius': {
                    property: 'Concentration',
                    stops: [
                      [0, 3],
                      [5, 15] ]    
                  },
                  'circle-color': {
                    property: 'Concentration',
                    stops: [
                      [0, '#2DC4B2'],
                      [1, '#3BB3C3'],
                      [2, '#669EC4'],
                      [3, '#8B88B6'],
                      [4, '#A2719B'],
                      [5, '#AA5E79'] ]
                  },
                  'circle-opacity': 0.8

                }, 'admin-2-boundaries-dispute'); // place the layer beneath this layer in the basemap


              document.getElementById('slider').addEventListener('input', function(e) {
                  // get the current hour as an integer 

                  var hour = e.target.value;
                  // hour = hour < 10 ? '0' + '' + hour + ':00:00+02:00': hour;
                  // map.setFilter(layer-name, filter)
                  filterHour = ['in', 'DateTime', hour];
                  map.setFilter('pollutants', ['all', filterHour, filterDay]); 

                  // converting 0-23 hour to AMPM format
                  var ampm = hour >= 12 ? 'PM' : 'AM';
                  var hour12 = hour % 12 ? hour % 12 : 12;
                  // update text in the UI
                  document.getElementById('active-hour').innerText = hour12 + ampm;
              });

              document.getElementById('filters').addEventListener('change', function(e) {
                  var day = e.target.value;
                  if (day === 'all') {
                    // `null` would not work for combining filters
                    filterDay = ['!=', 'Day', 'Bob'];
                  } else if (day === 'weekday') {
                    filterDay = ['!in', 'Day', 'Sat', 'Sun'];
                  } else if (day === 'weekend') {
                    filterDay = ['in', 'Day', 'Sat', 'Sun'];
                  } else {
                    console.log('error');
                  }
                  map.setFilter('pollutants', filterHour, filterDay);
              });
        
     }); 
     
       var stations1 = 'ams-air-quality/data/aqi_monitoring_network.geojson';

        // add markers
        map.on('load', function() {
          map.addSource('stations1', {
            type: 'geojson',
            data: 'ams-air-quality/data/aqi_monitoring_network.geojson'
          });   


          map.addLayer({
            id: 'point',
            type: 'symbol',
            source: {
              type: 'geojson',
              data: stations1
            },
            layout: {
              'icon-image': 'marker-15'
            },
            paint: { }
          });
        });

        // user event handle: mouseover
        var popup = new mapboxgl.Popup();

        map.on('mousemove', function(e) {
          var features = map.queryRenderedFeatures(e.point, { layers: ['stations1'] });
          if (!features.length) {
            popup.remove();
            return;
          }
          var feature = features[0];

          popup.setLngLat(feature.geometry.coordinates)
          .setHTML(feature.properties.Name)
          .addTo(map);
        });


        // user event handle: mouse click
        map.on('click', function(e) {
          // Return any features from the 'libraries' layer whenever the map is clicked
          var libraryFeatures = map.queryRenderedFeatures(e.point, { layers: ['stations1'] });
          if (!libraryFeatures.length) {
            return;
          }
          var libraryFeature = libraryFeatures[0];
     
        }); 
     
</script>
    
</body>    
</html>
